#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¥åº·æ•°æ®åˆ†æä¸»ç¨‹åº
"""

# ä½¿ç”¨
import pandas as pd
from pathlib import Path
import matplotlib.pyplot as plt

def åŠ è½½å¹¶æ¸…æ´—æ•°æ®(æ–‡ä»¶è·¯å¾„="data/health.csv"):
    """
    åŠ è½½å¹¶æ¸…æ´—å¥åº·æ•°æ®
    ä½ çš„åˆ—ï¼šindex, date, health, note, sleep, step
    """
# ç›´æ¥ç¡¬ç¼–ç è·¯å¾„
    æ–‡ä»¶è·¯å¾„ = Path("data/health.csv").absolute()
    print(f"ğŸ“‚ å°è¯•è¯»å–: {æ–‡ä»¶è·¯å¾„}")
    try:
        # è¯»å–æ•°æ®
        df = pd.read_csv(æ–‡ä»¶è·¯å¾„, encoding="utf-8")
        print(f"âœ… åŸå§‹æ•°æ®åŠ è½½æˆåŠŸï¼Œ{len(df)} æ¡è®°å½•")
        print(f"ğŸ“‹ åŸå§‹åˆ—å: {list(df.columns)}")
        
        # é‡å‘½ååˆ—ï¼ˆä¿æŒè‹±æ–‡æˆ–è½¬ä¸ºä¸­æ–‡ï¼Œæ ¹æ®ä½ çš„åå¥½ï¼‰
        åˆ—åæ˜ å°„ = {
            'index': 'åºå·',
            'date': 'æ—¥æœŸ',
            'health': 'å¥åº·çŠ¶æ€',  # 1=å¥åº·ï¼Œ0=å‘ä½œï¼Ÿ
            'note': 'å¤‡æ³¨',
            'sleep': 'ç¡çœ æ—¶é•¿',
            'step': 'æ­¥æ•°'
        }
        
        # æ£€æŸ¥å“ªäº›åˆ—å­˜åœ¨
        å®é™…åˆ—å = list(df.columns)
        é‡å‘½åå­—å…¸ = {}
        
        for è‹±æ–‡åˆ—, ä¸­æ–‡åˆ— in åˆ—åæ˜ å°„.items():
            if è‹±æ–‡åˆ— in å®é™…åˆ—å:
                é‡å‘½åå­—å…¸[è‹±æ–‡åˆ—] = ä¸­æ–‡åˆ—
                print(f"  âœ… æ‰¾åˆ°åˆ—: {è‹±æ–‡åˆ—} â†’ {ä¸­æ–‡åˆ—}")
            else:
                # å°è¯•åŒ¹é…å¤§å°å†™å˜ä½“
                åŒ¹é…åˆ— = [col for col in å®é™…åˆ—å if col.lower() == è‹±æ–‡åˆ—.lower()]
                if åŒ¹é…åˆ—:
                    é‡å‘½åå­—å…¸[åŒ¹é…åˆ—[0]] = ä¸­æ–‡åˆ—
                    print(f"  ğŸ”„ åŒ¹é…åˆ—: {åŒ¹é…åˆ—[0]} â†’ {ä¸­æ–‡åˆ—}")
                else:
                    print(f"  âš ï¸  æœªæ‰¾åˆ°åˆ—: {è‹±æ–‡åˆ—}")
        
        # åº”ç”¨é‡å‘½å
        df = df.rename(columns=é‡å‘½åå­—å…¸)
        
        # æ•°æ®æ¸…æ´—å’Œè½¬æ¢
        print("\nğŸ”§ æ•°æ®æ¸…æ´—...")
        
        # 1. è½¬æ¢æ—¥æœŸï¼ˆå¤„ç†"2026å¹´1æœˆ28æ—¥"æ ¼å¼ï¼‰
        if 'æ—¥æœŸ' in df.columns:
            try:
                # å°è¯•å¤šç§æ—¥æœŸæ ¼å¼
                df['æ—¥æœŸ'] = pd.to_datetime(
                    df['æ—¥æœŸ'], 
                    format='%Yå¹´%mæœˆ%dæ—¥',
                    errors='coerce'
                )
                
                # å¦‚æœå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                if df['æ—¥æœŸ'].isna().any():
                    df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'], errors='coerce')
                
                print(f"  âœ… æ—¥æœŸè½¬æ¢å®Œæˆ")
                print(f"     æ—¶é—´èŒƒå›´: {df['æ—¥æœŸ'].min().date()} è‡³ {df['æ—¥æœŸ'].max().date()}")
            except Exception as e:
                print(f"  âŒ æ—¥æœŸè½¬æ¢å¤±è´¥: {e}")
        
        # 2. è½¬æ¢å¥åº·çŠ¶æ€
        if 'å¥åº·çŠ¶æ€' in df.columns:
            # ä½ çš„æ•°æ®ä¸­ï¼š1=å¥åº·ï¼Œ0=å‘ä½œï¼Ÿ
            # å…ˆæŸ¥çœ‹æœ‰å“ªäº›å€¼
            print(f"  ğŸ” å¥åº·çŠ¶æ€å”¯ä¸€å€¼: {df['å¥åº·çŠ¶æ€'].unique()}")
            
            # ç¡®ä¿æ˜¯æ•°å€¼ç±»å‹
            df['å¥åº·çŠ¶æ€'] = pd.to_numeric(df['å¥åº·çŠ¶æ€'], errors='coerce')
            
            # åˆ›å»ºæ›´æ˜ç¡®çš„åˆ—
            # å‡è®¾ï¼š1=å¥åº·/æ— å‘ä½œï¼Œ0=æœ‰å‘ä½œ
            df['æ˜¯å¦å‘ä½œ'] = (df['å¥åº·çŠ¶æ€'] == 0).astype(int)
            df['æ˜¯å¦å¥åº·'] = (df['å¥åº·çŠ¶æ€'] == 1).astype(int)
            
            print(f"  âœ… å¥åº·çŠ¶æ€è½¬æ¢å®Œæˆ")
            print(f"     å‘ä½œå¤©æ•°: {df['æ˜¯å¦å‘ä½œ'].sum()}")
            print(f"     å¥åº·å¤©æ•°: {df['æ˜¯å¦å¥åº·'].sum()}")
        
        # 3. è½¬æ¢ç¡çœ æ—¶é•¿
        if 'ç¡çœ æ—¶é•¿' in df.columns:
            df['ç¡çœ æ—¶é•¿'] = pd.to_numeric(df['ç¡çœ æ—¶é•¿'], errors='coerce')
            print(f"  âœ… ç¡çœ æ—¶é•¿è½¬æ¢å®Œæˆ")
            print(f"     å¹³å‡ç¡çœ : {df['ç¡çœ æ—¶é•¿'].mean():.1f}å°æ—¶")
        
        # 4. è½¬æ¢æ­¥æ•°
        if 'æ­¥æ•°' in df.columns:
            df['æ­¥æ•°'] = pd.to_numeric(df['æ­¥æ•°'], errors='coerce')
            print(f"  âœ… æ­¥æ•°è½¬æ¢å®Œæˆ")
            print(f"     å¹³å‡æ­¥æ•°: {df['æ­¥æ•°'].mean():.0f}æ­¥")
        
        # 5. ä»å¤‡æ³¨ä¸­æå–ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if 'å¤‡æ³¨' in df.columns:
            print(f"  ğŸ“ å¤‡æ³¨åˆ†æ:")
            print(f"     æœ‰å¤‡æ³¨çš„è®°å½•: {df['å¤‡æ³¨'].notna().sum()}")
            
            # æå–å…³é”®è¯
            df['æœ‰å™©æ¢¦'] = df['å¤‡æ³¨'].str.contains('å™©æ¢¦|å™©æ¢¦å¤š|å™©æ¢¦é¢‘ç¹', na=False)
            df['ç¡çœ å·®'] = df['å¤‡æ³¨'].str.contains('å¤±çœ |éš¾å…¥ç¡|æ—©é†’|ç¡çœ å·®', na=False)
            df['çŠ¶æ€ä½³'] = df['å¤‡æ³¨'].str.contains('ç²¾ç¥å¥½|çŠ¶æ€ä½³|ç²¾åŠ›è¶³', na=False)
            
            if df['æœ‰å™©æ¢¦'].any():
                print(f"     æœ‰å™©æ¢¦è®°å½•: {df['æœ‰å™©æ¢¦'].sum()}å¤©")
        
        # æ’åº
        if 'æ—¥æœŸ' in df.columns:
            df = df.sort_values('æ—¥æœŸ').reset_index(drop=True)
            print(f"  ğŸ”„ æŒ‰æ—¥æœŸæ’åºå®Œæˆ")
        
        print(f"\nğŸ‰ æ•°æ®æ¸…æ´—å®Œæˆï¼")
        print(f"   æœ€ç»ˆåˆ—æ•°: {len(df.columns)}")
        print(f"   æœ€ç»ˆè¡Œæ•°: {len(df)}")
        
        return df
        
    except FileNotFoundError:
        print(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {æ–‡ä»¶å}")
        print("è¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨")
        return None
    except Exception as e:
        print(f"âŒ æ•°æ®å¤„ç†å¤±è´¥: {e}")
        return None
# health_analysis_v2.py - é€‚åº”ä½ çš„æ–°æ•°æ®ç»“æ„
import pandas as pd
import matplotlib.pyplot as plt
from pathlib import Path
import warnings
warnings.filterwarnings('ignore')


def ç”Ÿæˆåˆ†ææŠ¥å‘Š(df):
    """ç”Ÿæˆè¯¦ç»†çš„å¥åº·åˆ†ææŠ¥å‘Š"""
    if df is None or len(df) == 0:
        return "æš‚æ— æ•°æ®"
    
    æŠ¥å‘Š = []
    æŠ¥å‘Š.append("=" * 60)
    æŠ¥å‘Š.append("            ğŸ“Š å¤šç»´å¥åº·åˆ†ææŠ¥å‘Š")
    æŠ¥å‘Š.append("=" * 60)
    
    # åŸºç¡€ä¿¡æ¯
    if 'æ—¥æœŸ' in df.columns:
        æŠ¥å‘Š.append(f"ğŸ“… åˆ†ææœŸé—´: {df['æ—¥æœŸ'].min().date()} è‡³ {df['æ—¥æœŸ'].max().date()}")
    
    æŠ¥å‘Š.append(f"ğŸ“ˆ æ€»è®°å½•å¤©æ•°: {len(df)} å¤©")
    
    # å¥åº·çŠ¶æ€åˆ†æ
    if 'æ˜¯å¦å‘ä½œ' in df.columns:
        å‘ä½œå¤©æ•° = df['æ˜¯å¦å‘ä½œ'].sum()
        å‘ä½œæ¯”ä¾‹ = å‘ä½œå¤©æ•° / len(df) * 100
        æŠ¥å‘Š.append(f"\nâš¡ ç™«ç—«å‘ä½œæƒ…å†µ:")
        æŠ¥å‘Š.append(f"   å‘ä½œå¤©æ•°: {å‘ä½œå¤©æ•°} å¤© ({å‘ä½œæ¯”ä¾‹:.1f}%)")
        æŠ¥å‘Š.append(f"   æœ€é•¿æ— å‘ä½œé—´éš”: {è®¡ç®—æœ€é•¿æ— å‘ä½œé—´éš”(df)} å¤©")
    
    if 'æ˜¯å¦å¥åº·' in df.columns:
        å¥åº·å¤©æ•° = df['æ˜¯å¦å¥åº·'].sum()
        å¥åº·æ¯”ä¾‹ = å¥åº·å¤©æ•° / len(df) * 100
        æŠ¥å‘Š.append(f"   å¥åº·å¤©æ•°: {å¥åº·å¤©æ•°} å¤© ({å¥åº·æ¯”ä¾‹:.1f}%)")
    
    # ç¡çœ åˆ†æ
    if 'ç¡çœ æ—¶é•¿' in df.columns:
        å¹³å‡ç¡çœ  = df['ç¡çœ æ—¶é•¿'].mean()
        ç¡çœ è¯„çº§ = è¯„ä¼°ç¡çœ è´¨é‡(å¹³å‡ç¡çœ )
        
        æŠ¥å‘Š.append(f"\nğŸ˜´ ç¡çœ è´¨é‡åˆ†æ:")
        æŠ¥å‘Š.append(f"   å¹³å‡ç¡çœ : {å¹³å‡ç¡çœ :.1f} å°æ—¶ - {ç¡çœ è¯„çº§}")
        æŠ¥å‘Š.append(f"   æœ€é•¿ç¡çœ : {df['ç¡çœ æ—¶é•¿'].max():.1f} å°æ—¶")
        æŠ¥å‘Š.append(f"   æœ€çŸ­ç¡çœ : {df['ç¡çœ æ—¶é•¿'].min():.1f} å°æ—¶")
        
        # ç¡çœ ä¸å‘ä½œçš„å…³ç³»
        if 'æ˜¯å¦å‘ä½œ' in df.columns:
            å‘ä½œæ—¥ç¡çœ  = df[df['æ˜¯å¦å‘ä½œ'] == 1]['ç¡çœ æ—¶é•¿'].mean() if df['æ˜¯å¦å‘ä½œ'].sum() > 0 else 0
            å¥åº·æ—¥ç¡çœ  = df[df['æ˜¯å¦å‘ä½œ'] == 0]['ç¡çœ æ—¶é•¿'].mean() if (df['æ˜¯å¦å‘ä½œ'] == 0).sum() > 0 else 0
            
            if å‘ä½œæ—¥ç¡çœ  > 0 and å¥åº·æ—¥ç¡çœ  > 0:
                æŠ¥å‘Š.append(f"   å‘ä½œæ—¥å¹³å‡ç¡çœ : {å‘ä½œæ—¥ç¡çœ :.1f} å°æ—¶")
                æŠ¥å‘Š.append(f"   å¥åº·æ—¥å¹³å‡ç¡çœ : {å¥åº·æ—¥ç¡çœ :.1f} å°æ—¶")
                æŠ¥å‘Š.append(f"   å·®å¼‚: {å¥åº·æ—¥ç¡çœ  - å‘ä½œæ—¥ç¡çœ :.1f} å°æ—¶")
    
    # è¿åŠ¨åˆ†æ
    if 'æ­¥æ•°' in df.columns:
        å¹³å‡æ­¥æ•° = df['æ­¥æ•°'].mean()
        è¿åŠ¨è¯„çº§ = è¯„ä¼°è¿åŠ¨é‡(å¹³å‡æ­¥æ•°)
        
        æŠ¥å‘Š.append(f"\nğŸƒ è¿åŠ¨æƒ…å†µåˆ†æ:")
        æŠ¥å‘Š.append(f"   å¹³å‡æ­¥æ•°: {å¹³å‡æ­¥æ•°:.0f} æ­¥ - {è¿åŠ¨è¯„çº§}")
        æŠ¥å‘Š.append(f"   æœ€é«˜æ­¥æ•°: {df['æ­¥æ•°'].max():.0f} æ­¥")
        æŠ¥å‘Š.append(f"   æœ€ä½æ­¥æ•°: {df['æ­¥æ•°'].min():.0f} æ­¥")
        
        # è¿åŠ¨ä¸å‘ä½œçš„å…³ç³»
        if 'æ˜¯å¦å‘ä½œ' in df.columns:
            å‘ä½œæ—¥æ­¥æ•° = df[df['æ˜¯å¦å‘ä½œ'] == 1]['æ­¥æ•°'].mean() if df['æ˜¯å¦å‘ä½œ'].sum() > 0 else 0
            å¥åº·æ—¥æ­¥æ•° = df[df['æ˜¯å¦å‘ä½œ'] == 0]['æ­¥æ•°'].mean() if (df['æ˜¯å¦å‘ä½œ'] == 0).sum() > 0 else 0
            
            if å‘ä½œæ—¥æ­¥æ•° > 0 and å¥åº·æ—¥æ­¥æ•° > 0:
                æŠ¥å‘Š.append(f"   å‘ä½œæ—¥å¹³å‡æ­¥æ•°: {å‘ä½œæ—¥æ­¥æ•°:.0f} æ­¥")
                æŠ¥å‘Š.append(f"   å¥åº·æ—¥å¹³å‡æ­¥æ•°: {å¥åº·æ—¥æ­¥æ•°:.0f} æ­¥")
    
    # å¤‡æ³¨åˆ†æ
    if 'æœ‰å™©æ¢¦' in df.columns:
        å™©æ¢¦å¤©æ•° = df['æœ‰å™©æ¢¦'].sum()
        if å™©æ¢¦å¤©æ•° > 0:
            æŠ¥å‘Š.append(f"\nğŸ˜¨ å™©æ¢¦æƒ…å†µ:")
            æŠ¥å‘Š.append(f"   æœ‰å™©æ¢¦è®°å½•: {å™©æ¢¦å¤©æ•°} å¤©")
            
            if 'æ˜¯å¦å‘ä½œ' in df.columns:
                å™©æ¢¦åå‘ä½œç‡ = df[df['æœ‰å™©æ¢¦']]['æ˜¯å¦å‘ä½œ'].mean() * 100
                æŠ¥å‘Š.append(f"   å™©æ¢¦åå‘ä½œæ¦‚ç‡: {å™©æ¢¦åå‘ä½œç‡:.1f}%")
    
    # è¶‹åŠ¿åˆ†æ
    if len(df) >= 7:
        æœ€è¿‘7å¤© = df.tail(7)
        æŠ¥å‘Š.append(f"\nğŸ“ˆ æœ€è¿‘7å¤©è¶‹åŠ¿:")
        
        if 'æ˜¯å¦å‘ä½œ' in æœ€è¿‘7å¤©.columns:
            æŠ¥å‘Š.append(f"   å‘ä½œæ¬¡æ•°: {æœ€è¿‘7å¤©['æ˜¯å¦å‘ä½œ'].sum()} æ¬¡")
        
        if 'ç¡çœ æ—¶é•¿' in æœ€è¿‘7å¤©.columns:
            æŠ¥å‘Š.append(f"   å¹³å‡ç¡çœ : {æœ€è¿‘7å¤©['ç¡çœ æ—¶é•¿'].mean():.1f} å°æ—¶")
        
        if 'æ­¥æ•°' in æœ€è¿‘7å¤©.columns:
            æŠ¥å‘Š.append(f"   å¹³å‡æ­¥æ•°: {æœ€è¿‘7å¤©['æ­¥æ•°'].mean():.0f} æ­¥")
    
    # å»ºè®®
    æŠ¥å‘Š.append(f"\nğŸ’¡ å¥åº·å»ºè®®:")
    
    if 'ç¡çœ æ—¶é•¿' in df.columns:
        if df['ç¡çœ æ—¶é•¿'].mean() < 7:
            æŠ¥å‘Š.append(f"   1. âš ï¸ ç¡çœ ä¸è¶³ï¼Œå»ºè®®å¢åŠ ç¡çœ æ—¶é—´")
        elif df['ç¡çœ æ—¶é•¿'].mean() > 9:
            æŠ¥å‘Š.append(f"   1. âš ï¸ ç¡çœ è¿‡é•¿ï¼Œæ³¨æ„ç¡çœ è´¨é‡")
        else:
            æŠ¥å‘Š.append(f"   1. âœ… ç¡çœ æ—¶é•¿è‰¯å¥½ï¼Œç»§ç»­ä¿æŒ")
    
    if 'æ­¥æ•°' in df.columns:
        if df['æ­¥æ•°'].mean() < 5000:
            æŠ¥å‘Š.append(f"   2. âš ï¸ è¿åŠ¨é‡ä¸è¶³ï¼Œå»ºè®®å¢åŠ æ—¥å¸¸æ´»åŠ¨")
        elif df['æ­¥æ•°'].mean() > 15000:
            æŠ¥å‘Š.append(f"   2. âš ï¸ è¿åŠ¨é‡è¾ƒå¤§ï¼Œæ³¨æ„é€‚å½“ä¼‘æ¯")
        else:
            æŠ¥å‘Š.append(f"   2. âœ… è¿åŠ¨é‡é€‚ä¸­ï¼Œç»§ç»­ä¿æŒ")
    
    if 'æœ‰å™©æ¢¦' in df.columns and df['æœ‰å™©æ¢¦'].sum() > len(df) * 0.3:
        æŠ¥å‘Š.append(f"   3. ğŸ˜¨ å™©æ¢¦é¢‘ç‡è¾ƒé«˜ï¼Œå»ºè®®æ”¾æ¾å¿ƒæƒ…ï¼Œé¿å…ç¡å‰åˆºæ¿€")
    
    æŠ¥å‘Š.append("=" * 60)
    
    return "\n".join(æŠ¥å‘Š)

def è®¡ç®—æœ€é•¿æ— å‘ä½œé—´éš”(df):
    """è®¡ç®—æœ€é•¿è¿ç»­æ— å‘ä½œå¤©æ•°"""
    if 'æ˜¯å¦å‘ä½œ' not in df.columns:
        return 0
    
    æœ€é•¿é—´éš” = 0
    å½“å‰é—´éš” = 0
    
    for æ˜¯å¦å‘ä½œ in df['æ˜¯å¦å‘ä½œ']:
        if æ˜¯å¦å‘ä½œ == 0:  # æ— å‘ä½œ
            å½“å‰é—´éš” += 1
            æœ€é•¿é—´éš” = max(æœ€é•¿é—´éš”, å½“å‰é—´éš”)
        else:  # æœ‰å‘ä½œ
            å½“å‰é—´éš” = 0
    
    return æœ€é•¿é—´éš”

def è¯„ä¼°ç¡çœ è´¨é‡(å¹³å‡ç¡çœ ):
    """è¯„ä¼°ç¡çœ è´¨é‡ç­‰çº§"""
    if å¹³å‡ç¡çœ  >= 8:
        return "ä¼˜ç§€ ğŸŒŸ"
    elif å¹³å‡ç¡çœ  >= 7:
        return "è‰¯å¥½ ğŸ‘"
    elif å¹³å‡ç¡çœ  >= 6:
        return "ä¸€èˆ¬ âš ï¸"
    else:
        return "ä¸è¶³ â—"

def è¯„ä¼°è¿åŠ¨é‡(å¹³å‡æ­¥æ•°):
    """è¯„ä¼°è¿åŠ¨é‡ç­‰çº§"""
    if å¹³å‡æ­¥æ•° >= 10000:
        return "æ´»è·ƒ ğŸƒ"
    elif å¹³å‡æ­¥æ•° >= 6000:
        return "é€‚ä¸­ ğŸ‘Œ"
    elif å¹³å‡æ­¥æ•° >= 3000:
        return "è½»åº¦ âš ï¸"
    else:
        return "ä¸è¶³ â—"

def ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨(df, è¾“å‡ºæ–‡ä»¶å¤¹="output"):
    """ç”Ÿæˆå¤šç»´å¥åº·æ•°æ®å¯è§†åŒ–"""
    if df is None or len(df) < 3:
        print("ğŸ“Š æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨ï¼ˆéœ€è¦è‡³å°‘3æ¡è®°å½•ï¼‰")
        return
    
    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    è¾“å‡ºè·¯å¾„ = Path(è¾“å‡ºæ–‡ä»¶å¤¹)
    è¾“å‡ºè·¯å¾„.mkdir(exist_ok=True)
    
    # è®¾ç½®ä¸­æ–‡å­—ä½“ï¼ˆå¦‚æœéœ€è¦ï¼‰
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
    plt.rcParams['axes.unicode_minus'] = False
    
    print(f"\nğŸ¨ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨...")
    
    # åˆ›å»ºå¤šä¸ªå­å›¾
    fig, axes = plt.subplots(3, 1, figsize=(12, 12))
    
    # å›¾1ï¼šç¡çœ æ—¶é•¿è¶‹åŠ¿
    ax1 = axes[0]
    ax1.plot(df['æ—¥æœŸ'], df['ç¡çœ æ—¶é•¿'], 'o-', color='skyblue', linewidth=2, markersize=6)
    ax1.axhline(y=df['ç¡çœ æ—¶é•¿'].mean(), color='red', linestyle='--', alpha=0.7, 
               label=f'å¹³å‡ {df["ç¡çœ æ—¶é•¿"].mean():.1f}h')
    
    # æ ‡è®°å‘ä½œæ—¥
    if 'æ˜¯å¦å‘ä½œ' in df.columns:
        å‘ä½œæ—¥ = df[df['æ˜¯å¦å‘ä½œ'] == 1]
        if len(å‘ä½œæ—¥) > 0:
            ax1.scatter(å‘ä½œæ—¥['æ—¥æœŸ'], å‘ä½œæ—¥['ç¡çœ æ—¶é•¿'], 
                       color='red', s=100, marker='X', label='å‘ä½œæ—¥', zorder=5)
    
    ax1.set_title('ç¡çœ æ—¶é•¿è¶‹åŠ¿', fontsize=14, pad=10)
    ax1.set_ylabel('å°æ—¶', fontsize=12)
    ax1.legend()
    ax1.grid(alpha=0.3)
    ax1.tick_params(axis='x', rotation=45)
    
    # å›¾2ï¼šæ­¥æ•°è¶‹åŠ¿
    ax2 = axes[1]
    ax2.bar(df['æ—¥æœŸ'], df['æ­¥æ•°'], color='lightgreen', alpha=0.7)
    ax2.axhline(y=df['æ­¥æ•°'].mean(), color='blue', linestyle='--', alpha=0.7,
               label=f'å¹³å‡ {df["æ­¥æ•°"].mean():.0f}æ­¥')
    
    ax2.set_title('æ¯æ—¥æ­¥æ•°', fontsize=14, pad=10)
    ax2.set_ylabel('æ­¥æ•°', fontsize=12)
    ax2.legend()
    ax2.grid(alpha=0.3)
    ax2.tick_params(axis='x', rotation=45)
    
    # å›¾3ï¼šå¥åº·çŠ¶æ€æ—¥å†
    ax3 = axes[2]
    
    # åˆ›å»ºå¥åº·çŠ¶æ€çŸ©é˜µï¼ˆç®€åŒ–ç‰ˆï¼‰
    if 'æ˜¯å¦å‘ä½œ' in df.columns:
        colors = ['green' if x == 0 else 'red' for x in df['æ˜¯å¦å‘ä½œ']]
        ax3.scatter(df['æ—¥æœŸ'], [1]*len(df), c=colors, s=100, alpha=0.7)
        
        # æ·»åŠ å›¾ä¾‹
        from matplotlib.patches import Patch
        legend_elements = [
            Patch(facecolor='green', alpha=0.7, label='å¥åº·æ—¥'),
            Patch(facecolor='red', alpha=0.7, label='å‘ä½œæ—¥')
        ]
        ax3.legend(handles=legend_elements, loc='upper right')
    
    ax3.set_title('å¥åº·çŠ¶æ€æ—¥å†', fontsize=14, pad=10)
    ax3.set_yticks([1])
    ax3.set_yticklabels(['çŠ¶æ€'])
    ax3.grid(alpha=0.3)
    ax3.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    
    # ä¿å­˜å›¾è¡¨
    å›¾è¡¨æ–‡ä»¶ = è¾“å‡ºè·¯å¾„ / "health_analysis.png"
    plt.savefig(å›¾è¡¨æ–‡ä»¶, dpi=300, bbox_inches='tight')
    plt.close()
    
    print(f"âœ… å›¾è¡¨å·²ä¿å­˜: {å›¾è¡¨æ–‡ä»¶.absolute()}")
    
    # ç”Ÿæˆç›¸å…³ç³»æ•°çƒ­åŠ›å›¾ï¼ˆå¦‚æœæ•°æ®è¶³å¤Ÿï¼‰
    if len(df) >= 5:
        try:
            # é€‰æ‹©æ•°å€¼åˆ—è®¡ç®—ç›¸å…³æ€§
            æ•°å€¼åˆ— = []
            for åˆ— in ['ç¡çœ æ—¶é•¿', 'æ­¥æ•°', 'æ˜¯å¦å‘ä½œ']:
                if åˆ— in df.columns:
                    æ•°å€¼åˆ—.append(åˆ—)
            
            if len(æ•°å€¼åˆ—) >= 2:
                import seaborn as sns
                corr_df = df[æ•°å€¼åˆ—].corr()
                
                plt.figure(figsize=(8, 6))
                sns.heatmap(corr_df, annot=True, cmap='coolwarm', center=0,
                          square=True, linewidths=1, cbar_kws={"shrink": 0.8})
                plt.title('å¥åº·æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ', fontsize=14, pad=20)
                
                çƒ­åŠ›å›¾æ–‡ä»¶ = è¾“å‡ºè·¯å¾„ / "correlation_heatmap.png"
                plt.savefig(çƒ­åŠ›å›¾æ–‡ä»¶, dpi=300, bbox_inches='tight')
                plt.close()
                
                print(f"âœ… ç›¸å…³åˆ†æå›¾å·²ä¿å­˜: {çƒ­åŠ›å›¾æ–‡ä»¶.absolute()}")
        except Exception as e:
            print(f"âš ï¸  ç”Ÿæˆç›¸å…³åˆ†æå›¾æ—¶å‡ºé”™: {e}")

def ä¸»å‡½æ•°():
    """ä¸»ç¨‹åºå…¥å£"""
    print("ğŸš€ å¯åŠ¨å¤šç»´å¥åº·åˆ†æç³»ç»Ÿ")
    print("=" * 60)
    
    # 1. åŠ è½½å¹¶æ¸…æ´—æ•°æ®
    df = åŠ è½½å¹¶æ¸…æ´—æ•°æ®("health.csv")
    
    if df is None:
        print("âŒ æ— æ³•åŠ è½½æ•°æ®ï¼Œç¨‹åºé€€å‡º")
        return
    
    # 2. æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
    print("\nğŸ“‹ æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰:")
    print(df.head())
    
    # 3. ç”ŸæˆæŠ¥å‘Š
    print("\n" + "=" * 60)
    æŠ¥å‘Š = ç”Ÿæˆåˆ†ææŠ¥å‘Š(df)
    print(æŠ¥å‘Š)
    
    # 4. ä¿å­˜æŠ¥å‘Š
    with open("output/health_report.txt", "w", encoding="utf-8") as f:
        f.write(æŠ¥å‘Š)
    print("ğŸ’¾ æŠ¥å‘Šå·²ä¿å­˜: output/health_report.txt")
    
    # 5. ç”Ÿæˆå›¾è¡¨
    ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨(df, "output/charts")
    
    print("\nğŸ‰ åˆ†æå®Œæˆï¼")
    print("   æŸ¥çœ‹ output/ æ–‡ä»¶å¤¹è·å–å®Œæ•´æŠ¥å‘Šå’Œå›¾è¡¨")

if __name__ == "__main__":
    ä¸»å‡½æ•°()
